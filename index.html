<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FLOW-FOIL Luminous Freestanding Display Kit Configurator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    :root { --primary:#000; --secondary:#fff; --accent:#06d6a2; --gray-light:#f5f5f5; --gray:#e0e0e0; --gray-dark:#888; }
    body { overflow-x:hidden; min-height:100vh; color:var(--primary); background:var(--secondary); }
    .container { display:flex; }
    .canvas-container {
      width:45%; height:100vh; position:fixed; top:0; left:0;
      background:var(--gray-light) center/cover no-repeat;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 0 20px rgba(0,0,0,0.1);
    }
    #canvas { width:100%; height:100%; display:block; }
    .loading-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.75); display:flex;
      align-items:center; justify-content:center; backdrop-filter:blur(5px); z-index:1000;
    }
    .spinner {
      border:5px solid rgba(255,255,255,0.3);
      border-top:5px solid var(--accent);
      border-radius:50%; width:50px; height:50px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .configurator {
      margin-left:45%; width:55%; min-height:100vh; padding:40px;
      background:var(--secondary); overflow-y:auto;
    }
    h1 { font-size:28px; font-weight:600; margin-bottom:16px; letter-spacing:-0.5px; }
    p  { font-size:15px; line-height:1.6; margin-bottom:24px; color:var(--gray-dark); }
    h2 { font-size:20px; font-weight:500; margin:32px 0 16px; color:var(--primary); }
    .required { color:var(--accent); margin-left:4px; }

    .material-options, .hotspot-panel {
      display:flex; gap:16px; flex-wrap:wrap; margin-bottom:32px;
    }
    .material-option, .hotspot-panel button {
      border:1px solid var(--gray); border-radius:6px; padding:12px 18px;
      background:var(--secondary); cursor:pointer; transition:all .3s;
      font-size:14px;
    }
    .material-option.active, .hotspot-panel button.active {
      border-color:var(--accent); background:rgba(0,255,0,0.05);
    }
    .material-option:hover, .hotspot-panel button:hover {
      border-color:var(--primary); transform:translateY(-2px);
    }
    .hotspot-panel { display:none; }
    .hotspot-panel p { width:100%; margin-bottom:8px; color:var(--gray-dark); font-style:italic; }

    .footer {
      margin-top:60px; padding-top:20px; border-top:1px solid var(--gray);
      font-size:12px; color:var(--gray-dark); text-align:center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="canvas-container">
      <div class="loading-overlay"><div class="spinner"></div></div>
      <canvas id="canvas"></canvas>
    </div>

    <div class="configurator">
      <h1>FLOW-FOIL Luminous Freestanding Display Kit</h1>
      <p>Click any of the 10 hotspots on the display to choose and load your sheet format. You can also toggle the base material.</p>

      <h2>Choose the base material<span class="required">*</span></h2>
      <div class="material-options">
        <div class="material-option active" data-material="metal">Metal</div>
        <div class="material-option" data-material="glass">Glass</div>
      </div>

      <h2>Select sheet format<span class="required">*</span></h2>
      <div id="hotspot-panel" class="hotspot-panel">
        <p>Click a hotspot, then choose a format:</p>
        <button data-format="a4vertical">A4 Vertical</button>
        <button data-format="a4landscape">A4 Landscape</button>
        <button data-format="a5vertical">A5 Vertical</button>
        <button data-format="a5landscape">A5 Landscape</button>
      </div>

      <div class="footer">
        © 2023 FLOW-FOIL Display Solutions. All rights reserved.
      </div>
    </div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
    }
  }
  </script>

  <script type="module">
  import * as THREE        from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { GLTFLoader     } from 'three/addons/loaders/GLTFLoader.js';
  import { RGBELoader     } from 'three/addons/loaders/RGBELoader.js';
  import { DRACOLoader    } from 'three/addons/loaders/DRACOLoader.js';

  // Renderer & Scene
  const canvas   = document.getElementById('canvas');
  const loading  = document.querySelector('.loading-overlay');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.outputColorSpace    = THREE.SRGBColorSpace;
  renderer.toneMapping         = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.2;
  renderer.shadowMap.enabled   = true;
  renderer.shadowMap.type      = THREE.PCFSoftShadowMap;

  const scene  = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
  camera.position.set(0,1.5,4);
  scene.add(camera);

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff,0.26));
  const dirL = new THREE.DirectionalLight(0xffffff,0.18);
  dirL.position.set(5,10,7); dirL.castShadow = true; scene.add(dirL);
  const fillL = new THREE.DirectionalLight(0xffffff,0.04);
  fillL.position.set(-5,4,-3); scene.add(fillL);

  // Controls
  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true; controls.dampingFactor = 0.05;
  controls.minDistance   = 0.5;  controls.maxDistance = 50;
  controls.enablePan     = true;

  window.addEventListener('resize', () => {
    const w = canvas.clientWidth, h = canvas.clientHeight;
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  });

  // Loaders
  const dracoLoader = new DRACOLoader().setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.5/');
  const loader      = new GLTFLoader().setDRACOLoader(dracoLoader);
  const rgbeLoader  = new RGBELoader();

  let fullModel;
  const modelParts   = {};
  const loadedSheets = {};

  // 1) Load HDR → holder → initial left-top sheet
  rgbeLoader.load('lapa_1k.hdr',
    hdr => {
      hdr.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = hdr;
      loadHolder();
    },
    undefined,
    loadHolder
  );

  function loadHolder() {
    loader.load('/adsholder.glb', gltf => {
      fullModel = gltf.scene;
      fullModel.traverse(o => {
        if (o.name) modelParts[o.name] = o;
        if (o.isMesh) {
          o.castShadow = o.receiveShadow = true;
          if (o.material?.map) {
            o.material.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
          }
        }
      });
      scene.add(fullModel);

      // Load initial a4vertr8 at left-top hotspot (id = 5)
      loader.load('/a4vertr8.glb', g => {
        const sheet = g.scene;
        const bb = new THREE.Box3().setFromObject(sheet);
        sheet.position.y -= bb.min.y;

        const group = new THREE.Group();
        group.add(sheet);
        group.position.set(-0.02, 1.753, 0.003);
        group.quaternion.copy(fullModel.quaternion);
        group.scale.copy(fullModel.scale);

        scene.add(group);
        loadedSheets[5] = group;
        loading.style.display = 'none';
      });
    },
    undefined,
    err => { console.error(err); loading.style.display = 'none'; }
    );
  }

  // Material toggle
  document.querySelectorAll('.material-option').forEach(el => {
    el.addEventListener('click', () => {
      const mat = el.dataset.material;
      document.querySelectorAll('.material-option')
              .forEach(b => b.classList.toggle('active', b === el));
      if (modelParts.metalbase)  modelParts.metalbase.visible = (mat === 'metal');
      if (modelParts.glassbase)  modelParts.glassbase.visible = (mat === 'glass');
      if (modelParts.holderpipe) modelParts.holderpipe.visible = true;
    });
  });

  // Hotspots
  const hotspotPositions = [
    [0.021,1.753,0.003],[0.021,1.404,0.003],[0.021,1.07,0.003],[0.021,0.726,0.03],[0.021,0.365,0.003],
    [-0.02,1.753,0.003],[-0.02,1.404,0.003],[-0.02,1.07,0.003],[-0.02,0.726,0.03],[-0.02,0.365,0.003]
  ];
  const hotspotMeshes = [];

  hotspotPositions.forEach((pos,i) => {
    const m = new THREE.Mesh(
      new THREE.SphereGeometry(0.02,8,8),
      new THREE.MeshBasicMaterial({color:0x06d6a2})
    );
    m.position.set(...pos);
    m.userData = { id:i, side: pos[0]>0?'right':'left' };
    scene.add(m);
    hotspotMeshes.push(m);
  });

  const raycaster = new THREE.Raycaster();
  const mouse     = new THREE.Vector2();
  let activeHotspot = null;

  renderer.domElement.addEventListener('pointerdown', e => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = ((e.clientX-rect.left)/rect.width)*2 - 1;
    mouse.y = -((e.clientY-rect.top)/rect.height)*2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(hotspotMeshes)[0];
    if (hit) {
      activeHotspot = hit.object;
      document.getElementById('hotspot-panel').style.display = 'flex';
    }
  });

  const mapR = { a4vertical:'a4vertlf8',a4landscape:'a4landslf8',a5vertical:'a5vertlf8',a5landscape:'a5landslf8' };
  const mapL = { a4vertical:'a4vertr8',a4landscape:'a4landsr8',a5vertical:'a5vertr8',a5landscape:'a5landsr8' };

  document.querySelectorAll('#hotspot-panel button').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!activeHotspot) return;
      const fmt = btn.dataset.format;
      const side= activeHotspot.userData.side;
      const file= (side==='right'?mapR[fmt]:mapL[fmt]) + '.glb';

      const prev = loadedSheets[activeHotspot.userData.id];
      if (prev) scene.remove(prev);

      loader.load('/'+file, gltf => {
        const sheet = gltf.scene;
        const bb    = new THREE.Box3().setFromObject(sheet);
        sheet.position.y -= bb.min.y;

        const group = new THREE.Group();
        group.add(sheet);
        group.position.copy(activeHotspot.position);
        group.quaternion.copy(fullModel.quaternion);
        group.scale.copy(fullModel.scale);

        scene.add(group);
        loadedSheets[activeHotspot.userData.id] = group;
      });

      document.getElementById('hotspot-panel').style.display = 'none';
    });
  });

  // Render loop
  (function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  })();
  </script>
</body>
</html>
